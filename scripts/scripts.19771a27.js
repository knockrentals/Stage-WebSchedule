!function(a){"use strict";a.module("webScheduleApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angularLodash","angular-momentjs","ngMask","LocalStorageModule","angular-bugsnag","datePicker","webScheduleConfig","ngMaterial","satellizer"]).config(["$routeProvider",function(a){a.when("/:companyName",{templateUrl:"views/scheduling.html",controller:"SchedulingController"}).when("/",{templateUrl:"views/scheduling.html",controller:"SchedulingController"}).otherwise({redirectTo:"/"})}]).config(["localStorageServiceProvider",function(a){a.setStorageType("localStorage"),a.setPrefix("knock-webSchedule-")}]).config(["bugsnagProvider",function(a){a.noConflict().apiKey("c2a18eb99aab1e48e5522549f39bf113")}]).config(["$mdThemingProvider",function(a){a.definePalette("knockPrimaryTheme",{50:"8ddbaf",100:"7cd5ab",200:"67cda7",300:"50c4a4",400:"3db29c",500:"2EB88F",600:"258684",700:"1e767b",800:"186771",900:"135a68",A100:"A7FFEB",A200:"64FFDA",A400:"1DE9B6",A700:"00BFA5",contrastDefaultColor:"light",contrastDarkColors:["50","100","200","300","400","A100"],contrastLightColors:void 0}),a.theme("default").primaryPalette("knockPrimaryTheme")}]).config(["$authProvider","apiConfig",function(a,b){a.tokenPrefix="knock",a.tokenName="token",a.loginUrl=b.host+"/auth/validate",a.signupUrl=b.host+"/auth/register",a.facebook({clientId:b.facebook.clientId,url:b.host+"/auth/facebook"}),a.linkedin({clientId:b.linkedin.clientId,url:b.host+"/auth/linkedin"})}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.controller("SchedulingController",["$scope","$moment","$routeParams","$interpolate","knockApi","$auth","_",function(a,b,c,d,e,f,g){var h=this,i=c.companyName;return i?(h._onListingChanged=function(){h._getListingPreferences()},h._getListingPreferences=function(){e.getListingPreferences(a.chosenTimesModel.listingId).success(function(a){h._setTourDurationMinutes(a.preferences.tour_duration)})},a.$watch("chosenTimesModel.listingId",function(){a.chosenTimesModel.listingId&&h._onListingChanged()}),h._setTourDurationMinutes=function(a){var c=b(a,"HH:mm:ss");h._tourDurationMinutes=60*c.hours()+c.minutes()},a.signupUserInfo={firstName:"",lastName:"",username:"",password:"",type:"renter"},a.renterProfile={was_evicted:!1,is_criminal:!1,pets:{none:!0,cats:!1,small_dogs:!1,large_dogs:!1},photo:"",email:""},a.chosenTimesModel={isFinished:!1,timeSelections:[],listingId:"",requestButtonDirty:!1},a.validation={signupIsFinished:!1,passedRequirements:!1,isLoggedIn:f.isAuthenticated()},h._updateLoggedIn=function(){a.validation.isLoggedIn?h._getProfile():a.renterProfile={was_evicted:!1,is_criminal:!1,pets:{none:!0,cats:!1,small_dogs:!1,large_dogs:!1},photo:"",email:""}},a.$watch("validation.isLoggedIn",h._updateLoggedIn),a.logout=function(){f.logout(),a.validation.isLoggedIn=!1},h._initialize=function(){e.getCompanyActiveListings(i).success(h._getListingsSuccess),a.validation.isLoggedIn&&h._getProfile()},h._getProfile=function(){e.getProfile().success(h._getProfileSuccess)},h._getProfileSuccess=function(b){a.renterProfile=b.profile,a.renterProfile.barePhone=a.renterProfile.phone.npa+a.renterProfile.phone.nxx+a.renterProfile.phone.xxxx},h._getListingsSuccess=function(b){var c=d('{{monthlyRent | currency:"$":0}} - {{bedrooms}} / {{bathrooms}} Bath - {{address}}'),e=d('Unit {{unit}} - {{bedrooms}} / {{bathrooms}} Bath - {{monthlyRent | currency:"$":0}} - {{size}} sqft');a.listings=g.map(b.listings,function(a){var b=a.floorplan.community_id?e:c,d=0===a.floorplan.bedrooms?"Studio":a.floorplan.bedrooms+" Bed";return a.title=b({monthlyRent:a.leasing.monthlyRent,bedrooms:d,bathrooms:a.floorplan.bathrooms,address:a.location.address.raw,name:a.floorplan.name,unit:a.location.address.unit,size:a.floorplan.size}),a}),a.chosenTimesModel.listingId=a.listings[0].id},a.tryRequestAppointment=function(){var b=(a.validation.isLoggedIn||a.validation.signupIsFinished)&&a.validation.passedRequirements&&a.chosenTimesModel.isFinished;a.chosenTimesModel.requestButtonDirty=!0,b&&(a.validation.isLoggedIn?h._updateProfile():h._register())},h._register=function(){a.isRequesting=!0,a.schedulingError=null,f.signup({user:a.signupUserInfo}).then(function(a){f.setToken(a.data.token),h._updateProfile()},function(b,c){a.isRequesting=!1,409===c&&(a.schedulingError="An account with that email already exists.")})},h._updateProfile=function(){a.isRequesting=!0,a.schedulingError=null,a.renterProfile.email=a.signupUserInfo.username,e.updateProfile(a.renterProfile).success(function(){h._requestAppointment()}).error(function(){a.isRequesting=!1})},h._requestAppointment=function(){var b=h._getRequestTimes();e.sendAppointmentRequest(a.chosenTimesModel.listingId,b).success(function(b){a.requests=b.requests})["finally"](function(){a.isRequesting=!1})},h._getRequestTimes=function(){return g.map(a.chosenTimesModel.timeSelections,function(a){var c=a.selection.format(),d=b(c).add(h._tourDurationMinutes,"minutes").format();return{start_time:c,end_time:d}})},void h._initialize()):void(a.missingCompanyName=!0)}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.directive("signupUserInfo",function(){return{restrict:"E",templateUrl:"views/signup-info.html",controller:"SignupUserInfoController",scope:{signupUserInfo:"=",signupIsFinished:"=",isLoggedIn:"="}}}),b.controller("SignupUserInfoController",["$scope","$auth",function(a,b){var c=this;a.login={username:"",password:"",type:"renter"},a.signupIsFinished=a.isLoggedIn,a.socialSignup=function(c){b.authenticate(c,{client_type:"web"}).then(function(){a.isLoggedIn=b.isAuthenticated(),a.signupIsFinished=!0},function(){a.socialSignupError=!0})},a.tryLogin=function(){return a.isLoggingIn=!0,b.login(a.login).then(function(c){b.setToken(c.data.token),a.isLoggingIn=!1,a.showLogin=!1,a.isLoggedIn=!0},function(){a.loginError=!0,a.isLoggingIn=!1})},c._onSignupInfoUpdated=function(){return a.isLoggedIn?void(a.signupIsFinished=!0):a.signupUserInfo.firstName&&a.signupUserInfo.lastName&&a.signupUserInfo.username?"renter"!==a.signupUserInfo.type?void(a.signupIsFinished=!1):a.signupUserInfo.password?void(a.signupIsFinished=!1):void(a.signupIsFinished=!0):void(a.signupIsFinished=!1)},a.$watch("signupUserInfo",c._onSignupInfoUpdated,!0)}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.directive("chooseTimes",function(){return{restrict:"E",templateUrl:"views/choose-times.html",controller:"ChooseTimesController",scope:{chosenTimesModel:"="}}}),b.controller("ChooseTimesController",["$scope","$moment","$interpolate","knockApi","_",function(a,b,c,d,e){var f=this,g=b().startOf("day").format(),h=b().startOf("day").add(2,"weeks").format();f._initialize=function(){a.onListingChanged()},a.$watch("chosenTimesModel.listingId",function(){a.chosenTimesModel.listingId&&a.onListingChanged()}),a.onListingChanged=function(){a.isLoadingTimes=!0,e.forEach(a.chosenTimesModel.timeSelections,function(a){a.selection=null}),a.chosenTimesModel.isFinished=!1,d.getAvailableTimes(a.chosenTimesModel.listingId,g,h).success(function(a){f._getAvailableTimesSuccess(a)})["finally"](function(){a.isLoadingTimes=!1})},f._getAvailableTimesSuccess=function(c){a.noAvailableTimes=!1,a.selectedSlot=null;var d=b(),g=b().add(7,"days"),h=function(a){return b(a).isAfter(d)},i=function(a){var c=b(a);return c.isAfter(d)&&c.isBefore(g)};return a.tourSlots=f._groupTimeSlots(c.tour_slots.filter(i)),a.autoAcceptSlots=f._groupTimeSlots(c.auto_acceptable.filter(i)),a.openHouseSlots=f._groupTimeSlots(c.open_house_slots.filter(h)),a.hasTourSlots=e.size(a.tourSlots)>0,a.hasOpenHouseSlots=e.size(a.openHouseSlots)>0,a.hasAutoAcceptSlots=e.size(a.autoAcceptSlots)>0,e.isEmpty(a.openHouseSlots)?e.isEmpty(a.autoAcceptSlots)?e.isEmpty(a.tourSlots)?void(a.noAvailableTimes=!0):(a.viewState="chooseTimes",a.availableTimesByDay=a.tourSlots,f._processTourTimes(),void(a.chosenTimesModel.timeSelections=[{selection:null},{selection:null},{selection:null}])):(a.viewState="autoAccept",a.availableTimesByDay=a.autoAcceptSlots,f._processTourTimes(),a.chosenTimesModel.timeSelections=[{selection:null}],void a.selectSlot(a.chosenTimesModel.timeSelections[0])):(a.viewState="openHouse",a.availableTimesByDay=a.openHouseSlots,f._processTourTimes(),a.chosenTimesModel.timeSelections=[{selection:null}],void a.selectSlot(a.chosenTimesModel.timeSelections[0]))},f._groupTimeSlots=function(a){return e.groupBy(a,function(a){var c=b(a);return c.year().toString()+"_"+c.dayOfYear()})},f._processTourTimes=function(){a.days=e.map(a.availableTimesByDay,function(a){var c=e.map(a,function(a){return b(a)}),d=e.sample(c).format("ddd Do");return{label:d,times:c}})},a.selectSlot=function(b){a.selectedSlot=b},a.selectDay=function(b){a.selectedDay=b},a.selectTime=function(b){a.selectedSlot.selection=b,a.clearFinishedSelection(),a.chosenTimesModel.isFinished=e.all(a.chosenTimesModel.timeSelections,function(a){return a.selection})},a.clearFinishedSelection=function(){a.selectedSlot=null,a.selectedDay=null},a.changeAutoAcceptDay=function(){a.chosenTimesModel.timeSelections[0].selection=null,a.selectSlot(a.chosenTimesModel.timeSelections[0])},a.isTimeSelected=function(b){for(var c=0;c<a.chosenTimesModel.timeSelections.length;c++)if(b===a.chosenTimesModel.timeSelections[c].selection)return!0;return!1},f._initialize()}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.directive("requirements",function(){return{restrict:"E",templateUrl:"views/requirements.html",controller:"RequirementsController",scope:{renterProfile:"=",chosenTimesModel:"=",passedRequirements:"="}}}),b.controller("RequirementsController",["$scope","$moment","knockApi","_",function(a,b,c,d){var e=this;a.renterCanAffordListing=!1,a.$watch("renterCanAffordListing",function(){e._checkRequirementsStillNeeded()}),a.$watch("renterProfile",function(){e._checkRequirementsStillNeeded()},!0),e._onPhoneChanged=function(b){b&&10===b.length?a.renterProfile.phone={npa:b.substr(0,3),nxx:b.substr(3,3),xxxx:b.substr(6,4)}:a.renterProfile.phone&&(a.renterProfile.phone=null)},a.$watch("renterProfile.barePhone",e._onPhoneChanged),e._onMoveDateChanged=function(c){if(c){var d=b(c).format();return d&&"Invalid date"!==d?void(a.renterProfile.target_move_date=d):void(a.renterProfile.target_move_date=null)}},a.$watch("renterProfile.target_move_date",e._onMoveDateChanged),e._onPetsChanged=function(b,c){var e=d.omit(b,"notes");b.none===c.none&&(a.renterProfile.pets.none=d.every(e,function(a,b){return"none"===b||a===!1}))},a.$watch("renterProfile.pets",e._onPetsChanged,!0),a.clearSelectedPets=function(){a.renterProfile.pets.cats=!1,a.renterProfile.pets.small_dogs=!1,a.renterProfile.pets.large_dogs=!1,a.renterProfile.pets.none=!0},e._initialize=function(){e._getListingRequirements()},e._getListingRequirements=function(){c.getListingRequirements(a.chosenTimesModel.listingId).success(e._getRequirementsSuccess)},e._getRequirementsSuccess=function(b){var c=b.requirements;return 0===c.length?(a.passedRequirements=!0,void(a.noRequirements=!0)):(a.requirementsByPolicy=d.groupBy(c,"policy"),a.needs=d.transform(a.requirementsByPolicy,function(a,b,c){a[c]=!0}),void e._checkRequirementsStillNeeded())},e._checkRequirementsStillNeeded=function(){if(a.requirementsByPolicy){if(a.stillNeeds={},a.needs.phone_numbers&&(a.stillNeeds.phone_numbers=d.isEmpty(a.renterProfile.phone)),a.needs.pet_policy){var b=d.omit(a.renterProfile.pets,"notes"),c=function(a){return a===!1},f=function(a){var c=a.pet;return!(c in b)||b[c]===!0};a.invalidNonePets=d.every(b,c),a.petConflicts=d.pluck(d.filter(a.requirementsByPolicy.pet_policy,f),"pet"),a.stillNeeds.pet_policy=d.any(a.requirementsByPolicy.pet_policy,f)||a.invalidNonePets}if(a.needs.income_multiplier){a.stillNeeds.income_multiplier=!a.renterCanAffordListing;var g=a.requirementsByPolicy.income_multiplier[0];a.minimumIncome=g.rent*g.multiplier,a.incomeMultiplier=g.multiplier,a.renterProfile.income=a.renterCanAffordListing?a.minimumIncome:0}a.needs.criminal_check&&(a.stillNeeds.criminal_check=!d.isBoolean(a.renterProfile.is_criminal)||a.renterProfile.is_criminal),a.needs.eviction_check&&(a.stillNeeds.eviction_check=!d.isBoolean(a.renterProfile.was_evicted)||a.renterProfile.was_evicted),a.needs.move_dates&&(a.stillNeeds.move_dates=d.isEmpty(a.renterProfile.target_move_date)),a.passedRequirements=!d.any(d.values(a.stillNeeds)),a.passedRequirements?a.errorMessages=[]:e._generateStillNeedsErrorMessages()}},e._generateStillNeedsErrorMessages=function(){a.errorMessages=[],a.stillNeeds.phone_numbers&&a.errorMessages.push("Manager requires a phone number."),a.stillNeeds.income_multiplier&&a.errorMessages.push("Manager requires a monthly income of "+a.minimumIncome),a.stillNeeds.pet_policy&&(a.invalidNonePets?a.errorMessages.push("Manager requires pet disclosure."):d.forEach(a.petConflicts,function(b){switch(b){case"cats":a.errorMessages.push("Property does not allow cats.");break;case"small_dogs":a.errorMessages.push("Property does not allow small dogs.");break;case"large_dogs":a.errorMessages.push("Property does not allow large dogs.")}})),a.stillNeeds.criminal_check&&a.errorMessages.push("Property requires no criminal history."),a.stillNeeds.eviction_check&&a.errorMessages.push("Property requires no eviction history."),a.stillNeeds.move_dates&&a.errorMessages.push("Manager requires a target move date.")},e._initialize()}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.directive("requestSent",function(){return{restrict:"E",templateUrl:"views/request-sent.html",controller:"RequestSentController",scope:{requests:"="}}}),b.controller("RequestSentController",["$window","$scope","$routeParams","$location","$q","$moment","knockApi","_",function(a,b,c,d,e,f,g,h){var i=this,j=function(a){var b=document.createElement("a");return b.href=a,b.hostname};b.redirectUrl=c.redirect,b.redirectUrl&&(b.host=j(b.redirectUrl)),i._updateTemplate=function(){if(b.requests&&0!==b.requests.length){var a=1===b.requests.length;b.headerText=a?"You're booked!":"Request sent!",b.formattedTimes=h.map(b.requests,function(a){return f(a.start_time).format("h:mma - ddd, MMM. D")}),a&&i._getCalendarLinks()}},b.$watch("requests",i._updateTemplate),i._getCalendarLinks=function(){b.isGettingCalendarLinks=!0;var a=[i._getCalendarUrl(),i._getGoogleCalendarUrl()];e.all(a)["finally"](function(){b.isGettingCalendarLinks=!1})},i._getGoogleCalendarUrl=function(){return g.getGoogleCalendarAppointmentLink(b.requests[0].id).success(function(a){b.googleLink=a.link})},i._getCalendarUrl=function(){return g.getCalendarUrl().success(function(a){b.calendarLink=a.url})},b.refresh=function(){a.location.reload()}}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.factory("knockApi",["$http","apiConfig",function(a,b){return{getProfile:function(){return a.get(b.host+"/profile")},getCompanyActiveListings:function(c){var d={name:c};return a.get(b.host+"/company/listings",{params:d})},getAvailableTimes:function(c,d,e){var f=b.host+"/listing/"+c+"/availableTimes",g={params:{start:d,end:e}};return a.get(f,g)},getListingRequirements:function(c){return a.get(b.host+"/listing/"+c+"/requirements")},getListingPreferences:function(c){return a.get(b.host+"/listing/"+c+"/manager/preferences")},updateProfile:function(c){return a.put(b.host+"/profile",c)},sendAppointmentRequest:function(c,d){var e={listing_id:c,requested_times:d,type:"tour",renter_notes:""},f={params:{s:"w"}};return a.post(b.host+"/appointments/request",e,f)},getCalendarUrl:function(){return a.get(b.host+"/calendar/future")},getGoogleCalendarAppointmentLink:function(c){return a.get(b.host+"/appointments/"+c+"/ics/google")}}}])}(window.angular),function(a){"use strict";var b=a.module("webScheduleApp");b.directive("emailValidator",function(){var a=/.+@.+\..+/i;return{require:"ngModel",restrict:"",link:function(b,c,d,e){e&&e.$validators.email&&(e.$validators.email=function(b){return e.$isEmpty(b)||a.test(b)})}}}),b.directive("phoneFormatter",function(){return{restrict:"AE",template:'<input mask="(999) 999-9999" clean="true" ng-pattern="barePhoneRegex" />',replace:!0,link:function(a){a.barePhoneRegex=/^\d{10}$/}}})}(window.angular);